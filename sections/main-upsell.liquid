{{ 'upsell.css' | asset_url | stylesheet_tag }}

<div class="upsell-page">
  {%- for block in section.blocks -%}
    {%- if block.type == 'upsell_title' -%}
      <div class="upsell-banner">
        {{ block.settings.upsell_text }}
      </div>
    {%- endif -%}
  {%- endfor -%}

  <div class="upsell-form-container upsell-container">
    <div class="upsell-content">
      {{ upsell.description }}
      <div class="upsell-footer">
        {{ upsell.footer }}
      </div>
    </div>
    <form id="upsell-form" action="/api/upsells/{{ upsell.id }}/answer" method="post">
      <input
        type="hidden"
        name="_token"
      />
      <input
        type="hidden"
        name="upsell_id"
        value="{{ upsell.id }}" 
      />
      <input
        type="hidden"
        name="order_id"
        value="{{ order.id }}" 
      />
      {%- for product in upsell.products %}
        <input
          type="hidden"
          name="product_offers[{{ product.id }}]"
          value="{{ product.variants.0.id }}"
        />
      {%- endfor %}
          
      <div class="upsell-form-submit">
      <button type="submit" name="answer" value="yes" class="upsell-submit-yes">
        <span class="button-text">{{ 'upsell.yes_submit_button' | t }}</span>
        <div class="spinner hidden"></div>
      </button>
      <button type="submit" name="answer" value="no" class="upsell-submit-no">
        <span class="button-text">{{ 'upsell.no_submit_button' | t }}</span>
        <div class="spinner hidden"></div>
      </button>
    </div>
    </form>
  </div>
</div> 

<script>
  document.getElementById("upsell-form").addEventListener("submit", function (event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);

  const answer = event.submitter.value;
  formData.set("answer", answer);

  const yesButton = document.querySelector(".upsell-submit-yes");
  const noButton = document.querySelector(".upsell-submit-no");
  const buttonText = event.submitter.querySelector(".button-text");
  const spinnerLoader = event.submitter.querySelector(".spinner");
  yesButton.disabled = true;
  noButton.disabled = true;
  buttonText.style.display = "none";
  spinnerLoader.style.display = "inline-block";

  fetch(form.action, {
    method: form.method,
    body: formData,
    headers: {
      Accept: "application/json",
    },
    credentials: "same-origin",
  })
    .then((response) => {
      if (response.ok) {
        window.location.href = "/checkout/thankyou";
      } else {
        yesButton.disabled = false;
        noButton.disabled = false;
        buttonText.style.display = "inline";
        spinnerLoader.style.display = "none";

        notify(response, "error");
      }
    })
    .catch((error) => {
      yesButton.disabled = false;
      noButton.disabled = false;
      buttonText.style.display = "inline";
      spinnerLoader.style.display = "none";

      notify(error, "error");
    });
});
</script>


{%- schema %}
  {
    "label": "Upsell",
    "blocks": [
      {
        "limit": 1,
        "type": "upsell_title",
        "label": "Title",
        "settings": [
          {
            "type": "richtext",
            "id": "upsell_text",
            "label": "Painer",
            "info": "HEHEHEHE"
          }
        ]
      }
    ],
    "settings": []
  }
{%- endschema %}
